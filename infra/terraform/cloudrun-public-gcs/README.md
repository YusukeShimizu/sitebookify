# Terraform: Cloud Run public + GCS artifacts (1 day lifecycle)

This Terraform creates the minimum GCP resources to run `sitebookify-app` on **public Cloud Run**.
Artifacts are stored in a **private GCS bucket** with a **1-day delete lifecycle**.
It can deploy either:
- single-service execution (`inprocess`)
- API + dedicated worker execution (`worker`)

## Prerequisites

- Terraform installed.
- GitHub CLI installed and authenticated (`gh auth status`) to read Actions run metadata.
- GCP project is created.
- Auth for Terraform:
  - `gcloud auth application-default login`
  - `gcloud config set project <PROJECT_ID>`
- OpenAI API key (if you use the OpenAI engine):
  - Set `OPENAI_API_KEY` / `SITEBOOKIFY_OPENAI_API_KEY` when running locally.
  - For Cloud Run, prefer Secret Manager:
    - Create a Secret Manager secret (example):
      - `gcloud secrets create sitebookify-openai-api-key --replication-policy=automatic`
      - `printf %s "$OPENAI_API_KEY" | gcloud secrets versions add sitebookify-openai-api-key --data-file=-`
    - Set `openai_api_key_secret_id = "sitebookify-openai-api-key"` in `terraform.tfvars`
    - Terraform grants the runtime service account `roles/secretmanager.secretAccessor`.
  - Quick test (not recommended): set `openai_api_key` in `terraform.tfvars` (stored in terraform state).

## Usage

```sh
cd infra/terraform/cloudrun-public-gcs
cp terraform.tfvars.example terraform.tfvars
$EDITOR terraform.tfvars

terraform init
# (recommended) Create the Artifact Registry repository first.
terraform apply -target=google_artifact_registry_repository.sitebookify

# Build + push + deploy are handled by CI on main.
# Terraform consumes the latest successful deploy SHA as a single source of truth.
# The wrapper checks current Cloud Run image diff before plan/apply.
./scripts/tf-with-ci-sha.sh plan
./scripts/tf-with-ci-sha.sh apply
```

Rollback guard example:

```sh
./scripts/tf-with-ci-sha.sh apply --allow-rollback
```

Destroy:

```sh
terraform destroy
```

## Notes

- Artifact deletion is implemented by **GCS lifecycle**: `age = 1` (days).
- Container image is derived from `deploy_sha`:
  - `<region>-docker.pkg.dev/<project_id>/<artifact_registry_repository_id>/<container_image_name>:sha-<deploy_sha>`
- `deploy_sha` should be injected by `scripts/tf-with-ci-sha.sh`; avoid pinning image tags in `terraform.tfvars`.
- Downloads use a **V4 signed URL** generated by the app.
  - Default TTL: 3600 seconds (configurable via `signed_url_ttl_secs`).
- Terraform sets the following env vars on the API Cloud Run service:
  - `SITEBOOKIFY_ARTIFACT_BUCKET`
  - `SITEBOOKIFY_SIGNED_URL_TTL_SECS`
  - `SITEBOOKIFY_EXECUTION_MODE`
  - `SITEBOOKIFY_WORKER_URL` (always set)
  - `SITEBOOKIFY_WORKER_AUTH_TOKEN` (set when `worker_auth_token` is configured)
- Worker mode settings:
  - Set `execution_mode = "worker"` to dispatch execution to the worker service.
  - Set `worker_auth_token` to protect `/internal/jobs/:job_id/run`.
  - Worker service receives `SITEBOOKIFY_INTERNAL_DISPATCH_TOKEN`.
- Cloud Run is made public by granting `roles/run.invoker` to `allUsers`.
